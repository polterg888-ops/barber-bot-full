import os
import logging
import asyncio
from datetime import datetime

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–∞
BOT_TOKEN = os.environ.get('BOT_TOKEN')
if not BOT_TOKEN:
    logger.error("‚ùå –û–®–ò–ë–ö–ê: –ù–µ –Ω–∞–π–¥–µ–Ω BOT_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")
    logger.error("–î–æ–±–∞–≤—å—Ç–µ BOT_TOKEN –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Render: Settings -> Environment")
    exit(1)

print("=" * 60)
print("üöÄ –¢–ï–õ–ï–ì–†–ê–ú –ë–û–¢ –î–õ–Ø –ë–ê–†–ë–ï–†–®–û–ü–ê")
print("=" * 60)

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é
        import telegram
        print(f"‚úÖ –í–µ—Ä—Å–∏—è python-telegram-bot: {telegram.__version__}")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        print("üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...")
        try:
            from database import init_db
            init_db()
            print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        except Exception as e:
            print(f"‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î: {e}")
        
        # –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è –≤–µ—Ä—Å–∏–∏ 21.x
        from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, filters
        
        # –°–æ–∑–¥–∞–µ–º Application (–≤–µ—Ä—Å–∏—è 21.x)
        print("ü§ñ –°–æ–∑–¥–∞–µ–º Application...")
        
        # –ü–†–ê–í–ò–õ–¨–ù–´–ô –°–ü–û–°–û–ë –¥–ª—è 21.x
        application = Application.builder().token(BOT_TOKEN).build()
        print("‚úÖ Application —Å–æ–∑–¥–∞–Ω")
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        print("üìù –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏...")
        
        from bot.handlers import start, admin_command, contact_handler, button_handler, text_handler
        
        # –ö–æ–º–∞–Ω–¥—ã
        application.add_handler(CommandHandler("start", start))
        application.add_handler(CommandHandler("admin", admin_command))
        
        # –ö–æ–Ω—Ç–∞–∫—Ç
        application.add_handler(MessageHandler(
            filters.CONTACT, 
            contact_handler
        ))
        
        # Callback –∫–Ω–æ–ø–∫–∏
        application.add_handler(CallbackQueryHandler(button_handler))
        
        # –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        application.add_handler(MessageHandler(
            filters.TEXT & ~filters.COMMAND, 
            text_handler
        ))
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        try:
            from bot.handlers import set_bot
            set_bot(application.bot)
            print("‚úÖ –ë–æ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
        except:
            print("‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è set_bot –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        
        print("‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")
        print("ü§ñ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞...")
        
        # –ó–ê–ü–£–°–ö –¥–ª—è –≤–µ—Ä—Å–∏–∏ 21.x
        await application.initialize()
        await application.start()
        await application.updater.start_polling()
        
        print("=" * 60)
        print("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        print("=" * 60)
        
        # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª
        await asyncio.Event().wait()
        
    except Exception as e:
        print(f"üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}")
        import traceback
        traceback.print_exc()
        raise

if __name__ == '__main__':
    asyncio.run(main())
