# main.py - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô
import os
import sys
import logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[logging.StreamHandler(sys.stdout)]
)
logger = logging.getLogger(__name__)

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞"""
    try:
        print("=" * 60)
        print("üöÄ –¢–ï–õ–ï–ì–†–ê–ú –ë–û–¢ –î–õ–Ø –ë–ê–†–ë–ï–†–®–û–ü–ê - –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø")
        print("=" * 60)
        
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞
        try:
            from config import BOT_TOKEN, ADMINS
            logger.info(f"‚úÖ –¢–æ–∫–µ–Ω: {'—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if BOT_TOKEN else '–ù–ï–¢!'}")
            logger.info(f"‚úÖ –ê–¥–º–∏–Ω—ã: {ADMINS}")
            
            if not BOT_TOKEN:
                logger.error("‚ùå BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
                return
                
        except ImportError as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ config.py: {e}")
            return
        
        # 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        try:
            from database import init_db
            init_db()
            logger.info("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
            return
        
        # 3. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±–æ—Ç–∞
        try:
            from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters
            
            app = Application.builder().token(BOT_TOKEN).build()
            logger.info("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ—Ç–∞ —Å–æ–∑–¥–∞–Ω–æ")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: {e}")
            return
        
        # 4. –ò–º–ø–æ—Ä—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (–≤–∞–∂–Ω–æ: –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
        try:
            # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            from bot.handlers import start, admin_command, contact_handler, button_handler, text_handler
            
            # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º set_application –æ—Ç–¥–µ–ª—å–Ω–æ
            from bot.handlers import set_application
            set_application(app)
            
            logger.info("‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã")
            
        except ImportError as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤: {e}")
            logger.error("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É bot/:")
            logger.error("1. __init__.py (–ø—É—Å—Ç–æ–π —Ñ–∞–π–ª)")
            logger.error("2. handlers.py")
            logger.error("3. admin_keyboards.py")
            logger.error("4. user_keyboards.py")
            return
        
        # 5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        try:
            app.add_handler(CommandHandler("start", start))
            app.add_handler(CommandHandler("admin", admin_command))
            app.add_handler(MessageHandler(filters.CONTACT, contact_handler))
            app.add_handler(MessageHandler(filters.TEXT & filters.ChatType.PRIVATE, text_handler))
            app.add_handler(CallbackQueryHandler(button_handler))
            
            logger.info("‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤: {e}")
            return
        
        # 6. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
        logger.info("=" * 60)
        logger.info("ü§ñ –ë–û–¢ –ó–ê–ü–£–©–ï–ù –°–û –í–°–ï–ú–ò –§–£–ù–ö–¶–ò–Ø–ú–ò:")
        logger.info("‚úÖ –ó–∞–ø–∏—Å—å –Ω–∞ —É—Å–ª—É–≥–∏")
        logger.info("‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–µ–π")
        logger.info("‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏")
        logger.info("‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º")
        logger.info("‚úÖ –ó–∞–∫—Ä—ã—Ç–∏–µ/–æ—Ç–∫—Ä—ã—Ç–∏–µ –≤—Ä–µ–º–µ–Ω–∏")
        logger.info("‚úÖ –†–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏")
        logger.info("=" * 60)
        
        app.run_polling(
            drop_pending_updates=True,
            allowed_updates=["message", "callback_query"]
        )
        
    except Exception as e:
        logger.error(f"üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}", exc_info=True)
        sys.exit(1)

if __name__ == '__main__':
    main()
